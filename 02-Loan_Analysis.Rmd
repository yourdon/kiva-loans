02 Kiva Loans: Exploratory Data Analysis
=============================

In this Rmd file, we take our processed Kiva loan file, which is a sample of the full dataset, and try to answer some basic questions. Because we're working only with a sample, we'll concern ourselves with sample statistics (e.g. lenders per loan), relative comparisons, rates, and trends, but not with global counts (e.g. loans per year).

We have two basic types of questions that we're interested in:

1. **What are the intra-relationships among loan initialization features?** Questions of this type will allow us to understand how loans vary from country to country, demographic to demographic, how descriptions relate to loan amounts, and so forth. 
2. **What are the inter-relationships between loan initialization features and features down the pipeline?** Questions of this type will allow us to ask how the features of the loan -- amount, country, demographics -- relate to how that loan is funded, disbursed, and repaid.

Let's load the file and get going.

```{r}
library(jsonlite)
library(ggplot2)
library(grid)
library(gridExtra)

loans = jsonlite::fromJSON("loan_sample.json")

loans$posted_datetime = strptime(loans$posted_datetime, format = "%Y-%m-%d %H:%M:%S")
loans$funded_datetime = strptime(loans$funded_datetime, format = "%Y-%m-%d %H:%M:%S")
loans$disbursal_datetime = strptime(loans$disbursal_datetime, format = "%Y-%m-%d %H:%M:%S")
loans$paid_datetime = strptime(loans$paid_datetime, format = "%Y-%m-%d %H:%M:%S")
```

# 1. Univariate EDA

## Missing data

First, let's just note that we do have some missing data.

```{r}
sum(is.na(loans)) / (15000*18)
```

Roughly 1% of the data in the sample are missing. Which fields have the most missing data?

```{r}
apply(apply(loans, 2, is.na), 2, mean)
```

All of the missing data occurs in date-related fields. This suggests we'll encounter NA's whenever we have breakages in the loan pipeline -- for example, when a loan doesn't get disbursed or doesn't get repaid.

Let's take a look at all the variables in our sampled loan file.

## Status

```{r}
summary(as.factor(loans[,2]))
```

Of the 15,000 loans in the sample, the vast majority (14197/15000 = 95%) have been paid back. We could restrict our analysis to the loans that have made it through the pipeline, since one could argue that everything else is in some sense "bad data"; on the other hand, it could be interesting to characterize the loans that didn't get paid back and see whether there are any noticeable patterns.  

Does the missing data have any relation to loan status?

```{r}
apply(apply(loans[loans$status == "paid",], 2, is.na), 2, mean)
sum(apply(apply(loans[loans$status == "paid",], 2, is.na), 2, mean)) / (14197*18)
```

Yes, there's hardly any missing data when we look only at repaid loans.

## Sector

```{r}
summary(as.factor(loans[,3]))
qplot(as.factor(loans[,3]))
```

Most of the loans are going to food, retail, and agriculture uses.

## Partner ID

```{r}
qplot(as.factor(loans[,4]))

partners = table(as.factor(loans[,4]))
mean(partners); sd(partners)
```

We see a lot of different partners with a large variance in their loan activity.

## Lender count

```{r}
qplot(loans[,5])
summary(loans[,5])
```

The median loan has 17 lenders, and the mean isn't much greater than that. We see a few loans with a large number of lenders. As a quick check -- is the loan with the most lenders also the loan with the greatest dollar amount?

```{r}
which.max(loans[,5]) == which.max(loans$terms.loan_amount)
```

It is.

## Countries

We have 49 unique countries in our sample (and probably more in the full dataset). Some claim a disproportionate number of the loans:

```{r}
qplot(as.factor(loans$location.country_code))
table(as.factor(loans$location.country_code))
```

The x-axis shows [country code](https://en.wikipedia.org/wiki/ISO_3166-1). The top 3 borrowers are The Philippines (PH), Peru (PE), and Cambodia (KH). The bottom 3 are Jordan (JO), the Ivory Coast (CI), and Congo (CD).

## Languages

How many different languages do descriptions come in?

```{r}
qplot(as.factor(sapply(loans[,6], length)))
```

There are only 1 or 2 languages per description as a rule. Which languages are most prevalent?

```{r}
qplot(as.factor(unlist(loans[,6])))
table(as.factor(unlist(loans[,6])))
```

English is by far the most common, though Spanish is in the same ballpark. French, Russian, and Vietnamese are far less common, as is [Indonesian](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes).

## Description length

How many characters do we average per description?

```{r}
qplot(loans$description.avgchar)
summary(loans$description.avgchar)
```

We see a postively skewed distribution here. There's one clear outlier at around 6000 characters. (Remember that we have averaged over languages, so this isn't the effect of lots of translations.) Let's take a quick look at this data point:

```{r}
loans[which.max(loans$description.avgchar),]
```

There doesn't seem to be anything unusual going on here. We could peek at the raw data to see whether the description reveals anything of interest, but let's forgo that for now.

## Borrower data

We have two pieces of data regarding the borrowers: their number and the fraction who are female.

```{r}
qplot(loans$b.num)
summary(loans$b.num)
```

Clearly, the majority of loans are going to a single borrower, but a non-negligible number of loans goes to multiple borrowers. It will be interesting to see how this affects lender behavior.

What about gender?

```{r}
qplot(loans$b.female)
summary(loans$b.female)
```

Most of the loans are going to females, or all-female groups, though about 20% go to males, or all-male groups. Because most loans go to single borrowers, we don't see many mixed-gender borrowing groups.

## Loan amount

What is the distribution of loan amounts (in USD)?

```{r}
qplot(loans$terms.loan_amount)
summary(loans$terms.loan_amount)
```

The median and mean are both under 1000 USD, but there is a long tail of loan amount snaking out to 5000 USD. We may wish to consider treating these loans as a separate class and investigate what their properties are.

## Pipeline time differences

Let's now look at the time differences between sequential steps in the pipeline: from posting to funding, from funding to disbursal, and from disbursal to repayment. For these profiles, we'll subset our sample, looking only at loans that were repaid.

```{r}
repaid = loans[loans$status == "paid", ]
```

### Time to funding

The `funded_timediff` variable accounts for the time difference between when a loan was posted on Kiva and when it was funded by users.

```{r}
qplot(repaid$funded_timediff)
summary(repaid$funded_timediff)
```

The median loan is funded by lenders in less than a day, and the first quartile is funded in 0.18 days, or about 4.3 hours! This is somewhat surprising, but we can re-interpret the median figure in terms that sound reasonable. Given that the median loan is 550 USD and the median number of lenders is 17, this means that for the median loans, 17 lenders laon 550 / 17 = 32.35 within the span of a day. Although we don't know the country codes of the lenders, for a developed nation, this doesn't sound unreasonable.

### Time to disbursal

The `disbursal_timediff` variable accounts for the time difference between when a loan was funded by lenders and when it was disbursed to borrowers. We observed earlier that many of the disbursal time differences were negative, indicating that the funds had been "pre-disbursed" -- that is, given to borrowers before they were funded by Kiva lenders, due to urgent needs. That presents a wrinkle for any sort of supply chain analysis. Nevertheless, let's take a look at the distribution for this variable.

```{r}
qplot(repaid$disbursed_timediff)
summary(repaid$disbursed_timediff)
```

So it seems that *most* loans were disbursed before they were posted, not just some. Another wrinkle is the maximum at t = 30.51 days. This value is close enough to the average number of days per month (366/12 = 30.5) to seem like an artifact of record keeping, and the sharpness of the peak reinforces that suspicion. We have another reason now to exclude this variable.  

### Time to repayment

The `paid_timediff` variable accounts for the time difference between when a loan was disbursed to a borrower and when it was repaid. 

```{r}
qplot(repaid$paid_timediff)
summary(repaid$paid_timediff)
```

Looking at the IQR, we see that most loans are repaid in the 7-10 month range, though some take as long as 3+ years. We could consider segmenting by repayment time.

## Times

Finally, we can look at plots of the times themselves.

```{r}
p1 = ggplot(data=repaid, aes(x=posted_datetime)) + geom_histogram(aes(y=..density..)) +
  geom_density(col=2)
p2 = ggplot(data=repaid, aes(x=funded_datetime)) + geom_histogram(aes(y=..density..)) +
  geom_density(col=3)
p3 = ggplot(data=repaid, aes(x=disbursal_datetime)) + geom_histogram(aes(y=..density..)) +
  geom_density(col=4)
p4 = ggplot(data=repaid, aes(x=paid_datetime)) + geom_histogram(aes(y=..density..)) +
  geom_density(col=5)

grid.arrange(p1, p2, p3, p4, ncol = 1)
```

Nothing too surprising here. We see a general trend of more loans per year across all time plots. The `paid_datetime` plot lags behind the others and extends into 2014, but we would expect that since repayment is the last link in the supply chain.